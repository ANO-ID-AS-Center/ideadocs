# Тестовый стенд Fabric с BFT

Довольно часто по мере разработки необходимо тестировать код в приближенных к реальным условиям. В больших компаниях уже отработан процесс деплоя, ну и мы, следуя тенденциям, хотим иметь возможность желательно одной командой запускать фабрику на наших машинах, и желательно, чтобы мы, как разработчики, могли сразу брать код из интересущей нас ветки и менять все, что можно, по своему желанию. 

## Задача
~~Изначально было~~ Необходмо запустить сеть Hyperledger Fabric на 4х виртуальных машинах c 4мя ордерами с консенсусом BFT, получить как можно больше информации о том, как он работает.

Из начальных ресурсов мы имеем:
- 4е виртуальные машины на Digital Ocean сконфигурированные так, что мы можем зайти в них на пользователя `root` с использованием SSH-ключа
- Репозиторий [SmartBFT Fabric](https://github.com/SmartBFT-Go/fabric) с основной веткой `release-1.4-BFT-3`, т.е. в рамках данной документации мы будем использовать fabric 1.4 (следующая задача перейти на фабрику 2.3)
- Наши руки и голова)
- (Опционально) Еще иметь ключи доступа к Digital Ocean Spaces - это S3 совместимое хранилище, нам оно нужно для хранения статики и прочих данных, чтобы под боком было центральное хранилище, куда будем класть данные для последующего анализа

::: tip Заметка про конфигурацию
<!-- ~~Так как мы еще маленькие и пока не можем в кубернетис.~~ -->
 Мы вручную скомпилируем фабрику, раскидаем ордереры по машинам, будем запускать пиры в докер контейнерах, и в полуручном режиме запускать сеть. С помощью скриптов, конечно)
:::

## Доступы
Мы имеем четыре машины (в нашем случае Ubuntu 20.04), на которые необходимо установить пакеты для компиляции фабрики и работы прочих утилит.

Допустим в нашем случае это:
| # 	|       IP       	| User 	|
|:-:	|:--------------:	|------	|
| 1 	|  188.166.61.6  	| bft1 	|
| 2 	| 104.248.203.58 	| bft2 	|
| 3 	| 134.209.84.187 	| bft3 	|
| 4 	| 142.93.226.97  	| bft4 	|

Таблица с IP-адресами и соответствующими пользователями, которых мы создали, и от имени которых мы бдуем осуществлять рао=боту на машинах (эти пользователи занесены в список `sudoers`, чтобы можно было запускать команды от имени администратора `sudo command`)

## Подготовка окружения

Поставим на машины необходимые пакеты, а именно для начала нам потребуются работа с гитом и компиляторы, в том числе `go`.

```bash
sudo apt update
sudo apt install -y gcc make git

# Установите Docker на https://docs.docker.com/engine/install/ubuntu/ на момент
# написания версия v20.10

# Установить docker-compose, или воспользоваться инструкциями ниже (2 строчки)
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Установите Golang на https://golang.org/dl/ версию v1.14, или воспользоваться
# инструкциями ниже (1 строчка)
wget -q -O - https://git.io/vQhTU | bash -s -- --version 1.14.12


# Это уже лично от меня, так как мы будем иметь дело с почти ручной настройкой
# машин, то нам не помешает "сервер", который будет держать приложения открытыми
# между нашими заходами. Я обычно использую tmux (вы же можете смотреть на
# альтернативы, типа gnu screen, или вообще открывать приложения в бэкграунде)
sudo apt install -y tmux
```
::: tip Заметка
Если что-то не получается, стоит заглянуть в документацию Fabric 1.4, там описаны необходимые зависимости для компиляции  
https://hyperledger-fabric.readthedocs.io/en/release-1.4/dev-setup/devenv.html
:::

::: info Информация
Может возникнуть вопрос: почему мы будем компилировать фабрику, можно же сразу использовать готовые докер-образы с DockerHub?

Ответ: а почему бы и нет)... ну или подробнее: в процессе деплоя нам потребуется внести изменения в протокол консенсуса, да и знание как скомпилировать фабрику, делает всю инфраструктуру более гибкой, так что если углубляться, рано или поздно эти знания действительно помогут. 
:::